defaults: &defaults
  working_directory: /tmp
  docker:
      - image: docker.nwnx.io:443/nwnxee/unified:builder

version: 2
jobs:
  build:
    <<: *defaults
    filters:
      tags:
        only: /.*/
    steps:
      - run: mkdir -p workspace
      - run: cd workspace
      - checkout
      - run: CC="gcc -m32" CXX="g++ -m32" cmake -DCMAKE_BUILD_TYPE=RelWithDebInfo .
      - run: make all
      - persist_to_workspace:
        root: /tmp/workspace

  deploy:
    <<: *defaults
    steps:
      - attach_workspace:
        at: /tmp/workspace

    filters:
      tags:
        only: /^build.*/
    branches:
      only: /master/
    steps:
      - run: Scripts/packageNWScript.sh
      - store_artifacts:
          path: Binaries
      
workflows:
  version: 2

  build-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build        
